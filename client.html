
<!doctype html>
<html>
<head>
<title>Heartbeat</title>

	<style>
		html {
			width: 100%;
			height: 100%;
			background-color: black;
			color: rgba(0,255,0,1);
			font-family: "Courier New", Courier, monospace;
		}
		
		body {
			padding: 0px;
			margin: 0px;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		
		header, footer {
			background-color: black;
			height: 40px;
			box-sizing: border-box;
		}
		
		header {
			display: block;
			width: 100%;
			margin: 0px;
			padding: 0px;
			border-bottom: 2px solid green;
		}
		
		header h1 {
			display: inline-block;
			width: auto;
			margin: 0px;
			padding: 0px;
		}
		
		header #pulse {
			float: right;
			content: "";
			display: block;
			position: absolute;
			top: 8px;
			right: 11px;
			width: 20px;
			height: 20px;
			border: 2px solid;
			border-radius: 20px;
			
			color: rgba(255,0,0, 0.6);
			background-color: rgba(255,0,0, 0.4);
		}
		
		header #pulse:before {
			content: "inactive";
			margin-left: -80px;
		}
		
		header #pulse.active:before {
			content: "active";
			margin-left: -60px;
		}
		
		#pulse.active {
			-webkit-animation: pulse1 1s linear infinite;
			-moz-animation: pulse1 1s linear infinite;
			-ms-animation: pulse1 1s linear infinite;
			animation: pulse1 1s linear infinite;
		}

		@keyframes "pulse1" {
			0% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
			90% {
				color: rgba(0,255,0, 0.3);
				background-color: rgba(0,255,0, 0.3);
			}
			100% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
		}
		
		@-moz-keyframes pulse1 {
			0% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
			90% {
				color: rgba(0,255,0, 0.3);
				background-color: rgba(0,255,0, 0.3);
			}
			100% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
		}
		
		@-webkit-keyframes "pulse1" {
			0% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
			90% {
				color: rgba(0,255,0, 0.3);
				background-color: rgba(0,255,0, 0.3);
			}
			100% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
		}
		
		@-ms-keyframes "pulse1" {
			0% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
			90% {
				color: rgba(0,255,0, 0.3);
				background-color: rgba(0,255,0, 0.3);
			}
			100% {
				color: rgba(0,255,0, 1);
				background-color: rgba(0,255,0, 0.8);
			}
		}
		
		main {
			overflow-y: scroll;
			overflow-x: hidden;
		}
		
		main::-webkit-scrollbar {
			width: 12px;
		}
		main::-webkit-scrollbar-track {
			background-color: rgba(0,255,0,0.2);
			border-left: 1px solid green;
		}
		main::-webkit-scrollbar-thumb {
			background-color: rgba(0,255,0,0.5);
		}
		main::-webkit-scrollbar-thumb:hover {
			background-color: rgba(0,255,0,0.5);
		}
		
		main .smoothieGraph .graph.offline {
			opacity: 0.3;
		}
		
		main .smoothieGraph .interface {
			margin-bottom: -10px;
			margin-top: 20px;
		}
		
		main .smoothieGraph .caption {
			float: right;
			font-weight: bold;
		}
		
		main .smoothieGraph .caption .rx {
			color: blue;
		}
		
		main .smoothieGraph .caption .tx {
			color: rgba(0,255,0,1);
		}
		
		
		footer {
			position: absolute;
			bottom: 0px;
			left: 0px;
			right: 0px;
			text-align: center;
			border-top: 2px solid green;
			padding: 10px;
			font-size: small;
			font-weight: bold;
			color: green;
		}
		
		footer ul {
			width: auto;
			list-style: none;
			float: right;
			padding: 0px;
			margin: 0px;
		}
		
		footer ul li {
			float: left;
		}
		
		footer ul li:before {
			content: "|";
			color: green;
			padding: 0px 10px;
		}
		
		footer ul li:first-child:before {
			content: "";
		}
		
		footer ul li a {
			color: rgba(0,255,0,1);
		}
	</style>

<script type="text/javascript" src="/socket.io/socket.io.js"></script>

<script type="text/javascript" src="static/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="static/smoothie/smoothie.js"></script>

<script type="text/javascript">
	$(document).ready(function() {
		var chartData = [[],[]];
		
		var settings = {
			scrollSpeed: 100
		}
		
		var activityTimer;
		
		var chartsData = {};
		
		io = io.connect();
		
		io.on('error', function(err) {
			alert("Error: " + err.code + ': ' + err.signal);
		});
		
		io.on('connect_failed', function(){
			alert('Connection Failed');
		});
		
		io.on('usercount_update', function(user_count){
			$('#user_count').text(user_count);
		});
		
		io.on('connect', function(){
			console.log('socket connected');
		});
		
		io.on('disconnect', function () {
			console.log('socket disconnected');
			
			$('#pulse').removeClass('active');
			
			$.map(chartsData, function(iface) {
				iface.chart.stop();
				iface.$chart.addClass('offline');
			});
		});
		
		io.on('initialize', function(data) {
			$('header h1').text(data.hostname);
			var ifaces = data.ifaces;
			
			$('main').empty();
				
			ifaces.forEach(function(iface) {
				chartsData[iface] = {
					rx: new TimeSeries(),
					tx: new TimeSeries()
				}
				
				if (!chartsData[iface].chart) {
					chartsData[iface].chart = new SmoothieChart({
						millisPerPixel: settings.scrollSpeed,
						grid: { 
							strokeStyle: 'rgba(0,255,0,0.3)'
						}
					});
				}
				
				if (!chartsData[iface].$chart) {
					var $chart = $(
						'<section class="smoothieGraph">' +
						'	<h2 class="rxtx_' + iface + ' interface">' + iface + '</h2> ' +
						'	<small class="rxtx_' + iface + ' caption"><span class="value">-</span> <span class="unit">Mbit/s</span></small>' +
						'	<canvas id="rxtx_' + iface + '" class="graph" width="400" height="200"></canvas>' +
						'</section>');
					
					chartsData[iface].$chart = $chart.find('canvas');
					$('main').append($chart);
				}
				
				var optionsRx = { strokeStyle: 'rgba(0, 0, 255, 1)', fillStyle: 'rgba(0, 0, 255, 0.4)', lineWidth: 2 };
				var optionsTx = { strokeStyle: 'rgba(0, 255, 0, 1)', fillStyle: 'rgba(0, 255, 0, 0.2)', lineWidth: 2 };
				
				chartsData[iface].chart.addTimeSeries(chartsData[iface].rx, optionsRx);
				chartsData[iface].chart.addTimeSeries(chartsData[iface].tx, optionsTx);
				
				chartsData[iface].chart.streamTo(chartsData[iface].$chart.get(0), settings.scrollSpeed*15 );
			});
			
			updateWidth();
		});
		
		io.on('data', function(data) {
			
			$('#pulse').addClass('active');
			window.clearTimeout(activityTimer);
			activityTimer = setTimeout(function() {
				$('#pulse').removeClass('active');
			}, 2000);
			
			var rx = data.rx/1000000;
			var tx = data.tx/1000000;
			
			chartsData[data.iface].rx.append(data.timestamp, rx);
			chartsData[data.iface].tx.append(data.timestamp, tx);
			
			$('.rxtx_'+data.iface+'.caption .value').html(
				'<span class="rx">rx:' + parseFloat(rx).toFixed(2) + '</span>' + 
				' / ' + 
				'<span class="tx">tx:' + parseFloat(tx).toFixed(2) + '</span>'
			);
		});
		
		function updateWidth() {
			console.log("updateWidth");
			var $body = $('body');
			var bodyWidth = $body.innerWidth();
			var scrollWidth = 12;
			
			$.map(chartsData, function(iface) {
				iface.$chart.attr('width', bodyWidth-scrollWidth);
				if (iface.chart) {
					SmoothieChart.prototype.resize.call(iface.chart);
				}
			}, this);
			
			var bodyHeight = $body.innerHeight();
			var headerHeight = $('header').innerHeight();
			var footerHeight = $('footer').innerHeight();
			var borderHeight = 2;
			
			$('main').height(bodyHeight-headerHeight-footerHeight-(2*borderHeight));
		}
		$(window).resize(updateWidth);
	});
</script>
</head>
<body>
	<header>
		<h1>Heardbeat</h1>
		<samp>Online Users: <small id="user_count">-</small></samp>
		<samp id="pulse"></samp>
	</header>
	
	<main>
		<i>waiting for data...</i>
	</main>
	
	<footer>
		<ul>
			<li><a href="https://opensource.org/licenses/AGPL-3.0">AGPL-3.0</a> by <a href="https://github.com/mojoaxel">mojoaxel</a></li>
			<li><a href="https://www.github.com">Source</a></li>
		</ul>
	</footer>
</body>
</html>
